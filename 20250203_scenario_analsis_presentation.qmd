---
title: "Scenario analysis"
subtitle: "An update on project to date"
author: "Gabriel Hobro and Fikriyudin Mufasir"
date: 2025-02-03
date-format: "D MMMM YYYY"
format: 
  revealjs:
    theme: [default, su_presentation.scss]
    embed-resources: true
transition: none
# chalkboard:
#   buttons: false
preview-links: auto
slide-number: false
auto-animate: true
footer: |
  "See the (private) repo [here](https://github.com/The-Strategy-Unit/nhp_scenario_analysis)"
---

```{r run_scripts}
source("scenario_v1.R")
source("scenario_impact_changes.R")
source("step_change_cliniplan.R")
```

## Overview

Focused on adapting the existing pages of the outputs app for the principal projection.

In later iterations, we can include a comparison of the distributions under each scenario and of the corresponding input parameters.

The following slides contain a breakdown of the initial suggestions...

## Summary table

::: columns
::: {.column width="40%"}

For summary table, we suggest the existing bar chart, grouped by the two scenarios.

Similarly to outputs app, would provide breakdowns by activity type, pod, and measure.

:::

::: {.column width="60%"}
```{r high-level-bar-chart}
create_bar_plot(data, "Inpatient", "Admissions", "Imperial NDG Inpatient Scenarios")

```
:::
:::

<!-- ## Length of stay breakdown -->

<!-- If we have something -->

## Waterfalls

::: columns
::: {.column width="40%"}

For waterfall chart, we suggest a facet of the existing chart to allow easy visual comparison on a fixed x-axis. 

We developed new version of outputs app code to ensure same ordering in each chart.

:::

::: {.column width="60%"}
```{r waterfall_example}
generate_waterfall_plot(pcfs_ndg1, pcfs_ndg2, 
                        activity_type_ndg1 = "ip", 
                        activity_type_ndg2 = "ip",
                        measure = "admissions", 
                        title = "Inpatient admissions waterfall scenario comparison", 
                        x_label = "Admissions", 
                        y_label = "Change factor")

```
:::
:::

## Mitigator impact chart

::: columns
::: {.column width="40%"}

Mitigator impact charts are relatively easily converted to grouped bar chart.

Could add option to arrange by scenario A or scenario B (not relevant in NDG variant example)
:::

::: {.column width="60%"}
```{r impact_slides}


library(cowplot)

# make a plot grid consisting of two panels
p1 <- impact_bar_plot(ndg_variants_sc_comparison,"activity_avoidance", "ip", "beddays", "Avoidance")

p2 <- impact_bar_plot(ndg_variants_sc_comparison,"efficiencies", "ip", "beddays", "Efficiencies")

plot_col <- plot_grid(p1, p2, nrow=2)

# now add the title
title <- ggdraw() + 
  draw_label(
    "Example mitigator impact charts",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

plot_grid(
  title, plot_col,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)
```
:::
:::

<!-- ## Activity in detail -->

<!-- If we have something -->

## Cliniplan

::: columns
::: {.column width="40%"}
   
Cliniplan workbook takes the Excel step counts and applies a series of conversions to adjust bed days and arrive at beds under an 85% occupancy.

We have encoded this into R, with a plan for a user input of bed occupancy rate, and have reproduced its chart of top 12 mitigators for bed impact.

:::

::: {.column width="60%"}
```{r clin-plan}
ggplot(calc_85_rate,
       aes(x=reorder(strategy,at_85), y=at_85, fill = Type)) + 
  geom_bar(stat = "identity") +
  coord_flip()  +
  ggtitle("Adjusted Beds at 85% Occupancy") +
  ylab("Beds") +
  xlab("Mitigator") +
    scale_fill_manual(values = c("#f9bf07","#686f73"), name="Type",
                      labels = c("Top 12", "Others")) +
  easy_center_title() + theme(text = element_text(family = "Segoe UI")) +
  theme(axis.text.x = element_text(family = "Segoe UI", size = 12, color="black")) +
  theme(axis.text.y = element_text(family = "Segoe UI", size = 12, color="black")) +
  theme(axis.title.x = element_text(family = "Segoe UI", size = 12, color="black")) +
  theme(axis.title.y = element_text(family = "Segoe UI", size = 12, color="black")) +
  theme(legend.title = element_text(family = "Segoe UI", size = 12, color="black")) +
  theme(legend.text = element_text(family = "Segoe UI", size = 12, color="black"))
```
:::
:::

## Later steps / feedback

Remaining outputs app pages (LoS breakdown and activity in detail)

Comparison of distributions and inputs

Do the previous analyses constitute an MVP?

Integration into outputs app


